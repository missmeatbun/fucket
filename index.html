<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>同意書契約書（Firestore 即時同步）</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .auth-wrapper {
      width: 100%;
      max-width: 650px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      padding: 10px;
      box-sizing: border-box;
      gap: 10px;
    }

    .login-panel {
      width: 100%;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 16px;
      box-sizing: border-box;
    }

    .login-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .login-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .login-field {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 120px;
    }

    .login-field label {
      font-size: 12px;
      margin-bottom: 2px;
    }

    .login-field input {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 14px;
    }

    .btn-login, .btn-logout {
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-login { background: #4caf50; color: #fff; }
    .btn-logout { background: #888; color: #fff; }

    .login-hint {
      margin-top: 6px;
      font-size: 11px;
      color: #777;
    }

    /* 聊天室 */
    .chat-wrapper {
      width: 100%;
      height: 70vh;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      padding: 10px;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .chat-title { font-size: 18px; font-weight: bold; }
    .chat-user { font-size: 12px; color: #555; text-align: right; }

    .chat-messages {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      overflow-y: auto;
      background: #fafafa;
      margin-top: 6px;
    }

    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 8px;
      gap: 6px;
    }

    .message-meta {
      font-size: 11px;
      color: #777;
      margin-bottom: 2px;
    }

    .message-text {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
      min-height: 30px;
      word-break: break-all;
      overflow-wrap: anywhere;
    }

    .message-text.editing {
      border-color: #666;
      background: #fffbe6;
    }

    .btn-delete {
      border: none;
      background: #ff6b6b;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .chat-input-area {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .input-box {
      flex: 1;
      min-width: 0;
      min-height: 60px;
      max-height: 140px;
      border: 2px solid #333;
      padding: 8px;
      border-radius: 6px;
      font-size: 16px;
      word-break: break-all;
      overflow-wrap: anywhere;
      overflow-y: auto;
    }

    .btn-send {
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .readonly-hint {
      margin-top: 4px;
      font-size: 11px;
      color: #888;
      text-align: right;
    }
  </style>
</head>
<body>

<div class="auth-wrapper">
  <!-- 登入區 -->
  <div id="loginPanel" class="login-panel">
    <div class="login-title">登入區（登入後才能發送 / 編輯 / 刪除）</div>
    <div class="login-row">
      <div class="login-field">
        <label>帳號</label>
        <input type="text" id="username" />
      </div>
      <div class="login-field">
        <label>密碼</label>
        <input type="password" id="password" />
      </div>
      <button id="loginBtn" class="btn-login">登入</button>
      <button id="logoutBtn" class="btn-logout">登出</button>
    </div>
    <div class="login-hint">（如有帳號問題請洽美美）</div>
  </div>

  <!-- 聊天室 -->
  <div id="chatWrapper" class="chat-wrapper">
    <div class="chat-header">
      <div class="chat-title">同意書契約書（Firestore 即時同步）</div>
      <div id="currentUserInfo" class="chat-user"></div>
    </div>

    <div id="chatMessages" class="chat-messages"></div>

    <div class="chat-input-area">
      <div id="editor" class="input-box" contenteditable="true">在這裡輸入內容...</div>
      <button id="sendBtn" class="btn-send">發送</button>
    </div>
    <div id="readonlyHint" class="readonly-hint">※ 未登入時僅能瀏覽</div>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
// Firebase 設定
var firebaseConfig = {
  apiKey: "AIzaSyDkLeWyX29s-loVtzQ6VQPv_NsP4nTt98E",
  authDomain: "fucket.firebaseapp.com",
  projectId: "fucket",
  storageBucket: "fucket.appspot.com",
  messagingSenderId: "1048588346288",
  appId: "1:1048588346288:web:5342bfe05e356e2d49ac75"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();
var messagesCol = db.collection("messages");

// DOM
var loginBtn = document.getElementById('loginBtn');
var logoutBtn = document.getElementById('logoutBtn');
var usernameInput = document.getElementById('username');
var passwordInput = document.getElementById('password');
var currentUserInfo = document.getElementById('currentUserInfo');
var readonlyHint = document.getElementById('readonlyHint');
var editor = document.getElementById('editor');
var sendBtn = document.getElementById('sendBtn');
var chatMessages = document.getElementById('chatMessages');

// 帳號清單
var validUsers = [
  { username: 'pf1087', password: '273324' },
  { username: 'pf1048', password: '821615' },
  { username: 'pf1259', password: 'pf1259' }
];

var currentUser = null;
var LOCAL_KEY = 'chatCurrentUser';

// 更新登入 UI
function updateLoginUI() {
  if (currentUser) {
    currentUserInfo.textContent = "已登入：" + currentUser;
    readonlyHint.textContent = "已登入，可發送 / 編輯 / 刪除";
  } else {
    currentUserInfo.textContent = "目前為訪客模式";
    readonlyHint.textContent = "※ 未登入時僅能瀏覽";
  }
}

// 自動登入
var saved = localStorage.getItem(LOCAL_KEY);
if (saved) {
  currentUser = saved;
}
updateLoginUI();

// 登入
loginBtn.addEventListener("click", function(){
  var u = usernameInput.value.trim();
  var p = passwordInput.value.trim();

  var found = validUsers.find(x => x.username === u && x.password === p);
  if (!found) return alert("帳號或密碼錯誤");

  currentUser = u;
  localStorage.setItem(LOCAL_KEY, u);
  updateLoginUI();
  alert("登入成功");
});

// 登出
logoutBtn.addEventListener("click", function(){
  currentUser = null;
  localStorage.removeItem(LOCAL_KEY);
  updateLoginUI();
  alert("已登出");
});

// ENTER 發送（Shift + Enter 換行）
editor.addEventListener('keydown', function(event) {
  if (event.key === "Enter") {
    if (event.shiftKey) return; // 換行
    event.preventDefault(); // 阻止換行
    sendBtn.click();        // 直接發送
  }
});

// 發送
sendBtn.addEventListener("click", function(){
  var text = editor.innerText.trim();
  if (!text) return alert("請輸入內容");
  if (!currentUser) return alert("請先登入才能發送");

  messagesCol.add({
    text: text,
    user: currentUser,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  editor.innerText = "";
});

// linkify
function linkify(text) {
  var escaped = text.replace(/</g,"&lt;").replace(/>/g,"&gt;");
  var pattern = /((https?:\/\/[^\s]+)|(www\.[^\s]+)|(([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(\/[^\s]*)?))/g;
  return escaped.replace(pattern, m => `<a href="${m.startsWith("http")?m:"http://"+m}" target="_blank">${m}</a>`);
}

// Firestore 監聽
messagesCol.orderBy("createdAt","asc").onSnapshot(function(snap){
  chatMessages.innerHTML = "";
  snap.forEach(doc => {
    var d = doc.data();
    var wrap = document.createElement("div");
    wrap.className = "message";

    var meta = document.createElement("div");
    meta.className = "message-meta";
    meta.textContent = "由 " + d.user;

    var txt = document.createElement("div");
    txt.className = "message-text";
    txt.innerHTML = linkify(d.text);

    // 允許登入者編輯
    txt.addEventListener("dblclick", function(){
      if (!currentUser) return alert("請登入後才能編輯");
      txt.contentEditable = true;
      txt.classList.add("editing");
    });

    txt.addEventListener("blur", function(){
      if (!txt.classList.contains("editing")) return;
      txt.classList.remove("editing");
      txt.contentEditable = false;
      messagesCol.doc(doc.id).update({ text: txt.innerText.trim() });
    });

    var del = document.createElement("button");
    del.className = "btn-delete";
    del.textContent = "刪除";
    del.addEventListener("click", function(){
      if (!currentUser) return alert("請登入後才能刪除");
      messagesCol.doc(doc.id).delete();
    });

    wrap.appendChild(del);
    wrap.appendChild(meta);
    wrap.appendChild(txt);
    chatMessages.appendChild(wrap);
  });

  chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
</body>
</html>
